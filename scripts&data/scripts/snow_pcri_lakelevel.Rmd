---
title: "Snowcover vignette for PI Charter"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
---

#To-do: 
1. Snowcover effects on clp abund for all lakes where the DB has multiple CLP projects
- non-local winter data
- 

2. Compare my results to old ones! Lake past, neighbors, watershed, state?


# Prep WS
```{r}
#load libraries
library(data.table)
library(tidyr)
library(stringr)
library(ggplot2)
library(plotly)


#import Data
surveys <- fread("scripts&data/data/input/lake_year_data.csv")
rawdata <- fread("scripts&data/data/input/PCRIsurveysPICharter2srt_sheet1rawdata.csv")
  
```


#data explore
```{r}
#see if we can re-generate ray's calc'd CLP values
head(rawdata)
  rawdata[ , .N , .(SURVEY_START, DOW) ]
  names(rawdata)[str_detect(names(rawdata), "pota")]
  
#alltime max vet depth 
  
  a <- rawdata[ , .("survey_ident"= .GRP, "totnsamp" = .N, "clpN" = sum(potamogeton_crispus >= 1, na.rm = T), "lat_median" = median(latitude, na.rm = T), "lon_median" = median(longitude, na.rm = T)) ,   , .(SURVEY_START, DOW) ][ , clpfoc := clpN/totnsamp ,]
  
  
  #get snow data https://www.wrcc.dri.edu/cgi-bin/cliMAIN.pl?mn5435
snow <- fread("scripts&data/data/input/MSP_snowfall_alltime.csv")
  snow

#add snow to plant abund data:
  a[ , date := as.IDate(SURVEY_START, format = "%m/%d/%Y") , ]
  a[ , year := year(date) , ]
  
  
  a[snow, on = .(year = Winter_end_year ) , annual_snowfall := ANN]

  a[ DOW %in% a[ ,.N , DOW][N>2, DOW], .N ,  DOW]
  
  a[ , county := substr(str_pad(as.character(DOW),pad = "0", side = "left", width = 8), start = 1, stop = 2) , ]
  
  a
  
  a <- a[ county %in% c("02", "27", "19", "62", "82", "10" ,"70")  ]

a[ ,.N , DOW][N>2, DOW]
  
a[ DOW %in% a[ ,.N , DOW][N>2, DOW] , hist(year) ]


ggplot(a[DOW %in% a[year > 2015 ,.N , DOW][N>2, DOW] & year > 2015, , ] , aes( annual_snowfall, clpfoc), )+
   geom_point()+
   geom_smooth(method = "lm")+
   facet_wrap(~DOW, scales = "free")

summary(lm(clpfoc~annual_snowfall, data = a[DOW %in% a[,.N , DOW][N>2, DOW], , ]))


plotpanels <- ggplot(a[DOW %in% a[ ,.N , DOW][N>2, DOW], , ], aes( annual_snowfall, clpfoc, group = as.factor(DOW)) )+
  geom_point(aes(color = as.factor(DOW)))+
  geom_smooth(aes(color = as.factor(DOW)), method = "lm", se = F)

ggplotly(plotpanels)

```

So, from that plot I'd say the answer is no, a lake manager can't just use the MSP snowcover to assess effects on CLP.


To do list: 
- exclude non 7co metro -DONE
- run before 2016 - DONE
- 

# Figure for Vignette
```{r}
# make a background of "all data"

ggplot(a , aes( annual_snowfall, clpfoc), )+
   geom_point()+
   geom_smooth(method = "lm")


# show two lakes on top, one with increasing and one with decreasing snow relationships

# decrease w/ snow
ggplot(a[DOW %in% c("62005400"), , ] , aes( annual_snowfall, clpfoc), )+
   geom_point()+
   geom_smooth(method = "lm")



# increase w/ snow
ggplot(a[DOW %in% c("82010600"), , ] , aes( annual_snowfall, clpfoc), )+
   geom_point()+
   geom_smooth(method = "lm")



```

So, from that plot I'd say the answer is no, a lake manager can't just use the MSP snowcover to assess effects on CLP. 






